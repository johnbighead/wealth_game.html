<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è´¢å¯Œåšå¼ˆï¼šä¿é™©ä¸è£¸å¥”</title>
    <style>
        * { box-sizing: border-box; touch-action: manipulation; }
        body { 
            background: #000; color: #fff; font-family: -apple-system, sans-serif; 
            margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        /* é¡¶éƒ¨ç»Ÿè®¡æ  */
        header { 
            background: #1a1a1a; padding: 10px; display: flex; justify-content: space-around;
            border-bottom: 1px solid #333; font-size: 13px;
        }
        .stat-group { text-align: center; }
        .stat-label { color: #888; display: block; margin-bottom: 2px; }
        .cyan { color: #00f2ff; font-weight: bold; }
        .red { color: #ff4d4d; font-weight: bold; }

        /* ä¸»ç”»å¸ƒåŒº */
        #container { flex: 1; position: relative; background: #000; }
        canvas { display: block; }
        .overlay-label {
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5);
            padding: 4px 8px; font-size: 10px; border-radius: 4px; pointer-events: none;
        }

        /* åº•éƒ¨æ§åˆ¶åŒº */
        footer { 
            background: #1a1a1a; padding: 15px; border-top: 1px solid #333;
            display: flex; flex-direction: column; gap: 10px;
        }
        .controls-row { display: flex; gap: 10px; align-items: center; }
        button {
            flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold;
            font-size: 14px; cursor: pointer;
        }
        .btn-reset { background: #333; color: #fff; }
        .btn-pause { background: #00f2ff; color: #000; }
        
        .slider-box { flex: 2; font-size: 12px; color: #ccc; }
        input[type="range"] { width: 100%; margin-top: 5px; }
    </style>
</head>
<body>

<header>
    <div class="stat-group">
        <span class="stat-label">å‚ä¿ç»„å­˜æ´»</span>
        <span id="ins-alive" class="cyan">0</span>
    </div>
    <div class="stat-group">
        <span class="stat-label">è£¸å¥”ç»„å­˜æ´»</span>
        <span id="uni-alive" class="red">0</span>
    </div>
    <div class="stat-group">
        <span class="stat-label">è´¢å¯Œæ¯” (å‚ä¿/è£¸å¥”)</span>
        <span id="wealth-ratio" style="color: #ffd700;">1.0</span>
    </div>
</header>

<div id="container">
    <div class="overlay-label">é’è‰²å…‰ç¯ï¼šå‚ä¿ç»„ | çº¢è‰²ç²’å­ï¼šå¸¸è§„é£é™©</div>
    <canvas id="simCanvas"></canvas>
</div>

<footer>
    <div class="controls-row">
        <div class="slider-box">
            é£é™©é¢‘ç‡: <span id="v-risks">30</span>
            <input type="range" id="p-risks" min="10" max="100" value="30">
        </div>
        <div class="slider-box">
            ä¿é™©å‡ä¼¤: <span id="v-rate">90</span>%
            <input type="range" id="p-rate" min="50" max="99" value="90">
        </div>
    </div>
    <div class="controls-row">
        <button class="btn-reset" onclick="init()">ğŸ”„ é‡ç½®æ¨¡æ‹Ÿ</button>
        <button class="btn-pause" onclick="togglePause()" id="pauseBtn">â¸ æš‚åœ</button>
    </div>
</footer>

<script>
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    let families = [], risks = [], goods = [];
    let isPaused = false;

    // å‚æ•°é…ç½®
    let conf = {
        pop: 160,        // æ‰‹æœºå±å¹•è¾ƒå°ï¼Œå‡å°‘äººå£ä¿è¯æµç•…
        damage: 40,
        insRate: 0.9,
        insCost: 0.05,
        riskCount: 30
    };

    class Family {
        constructor(isInsured) {
            this.hasIns = isInsured;
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.vx = (Math.random() - 0.5) * 2.5;
            this.vy = (Math.random() - 0.5) * 2.5;
            this.wealth = 100;
            this.alive = true;
            this.flash = 0;
        }
        update() {
            if (!this.alive) return;
            this.x += this.vx; this.y += this.vy;
            if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
            if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
            
            if (this.hasIns) this.wealth -= conf.insCost;
            if (this.wealth <= 0) this.alive = false;
            if (this.flash > 0) this.flash--;
        }
        draw() {
            if (!this.alive) return;
            if (this.hasIns) {
                ctx.strokeStyle = "rgba(0, 242, 255, 0.5)";
                ctx.beginPath(); ctx.arc(this.x, this.y, 8, 0, Math.PI*2); ctx.stroke();
            }
            ctx.fillStyle = this.flash > 0 ? "#fff" : (this.hasIns ? "#00f2ff" : "#ff4d4d");
            ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI*2); ctx.fill();
        }
    }

    class Risk {
        constructor() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.vx = (Math.random() - 0.5) * 4;
            this.vy = (Math.random() - 0.5) * 4;
        }
        update() {
            this.x += this.vx; this.y += this.vy;
            if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
            if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
        }
        draw() {
            ctx.fillStyle = "#ff4d4d";
            ctx.font = "14px Arial";
            ctx.fillText("Ã—", this.x - 4, this.y + 5);
        }
    }

    function init() {
        // è‡ªé€‚åº”ç”»å¸ƒå¤§å°
        const container = document.getElementById('container');
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;

        families = [];
        for (let i = 0; i < conf.pop; i++) {
            families.push(new Family(i < conf.pop / 2));
        }
        updateRisks();
        isPaused = false;
    }

    function updateRisks() {
        risks = Array.from({length: conf.riskCount}, () => new Risk());
    }

    function loop() {
        if (!isPaused) {
            ctx.fillStyle = "rgba(0,0,0,0.2)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            risks.forEach(r => { r.update(); r.draw(); });

            let insWealth = 0, uniWealth = 0, insCount = 0, uniCount = 0;

            families.forEach(f => {
                if (!f.alive) return;
                f.update();
                risks.forEach(r => {
                    if (Math.hypot(f.x - r.x, f.y - r.y) < 12) {
                        let d = Math.random() * conf.damage;
                        if (f.hasIns) d *= (1 - conf.insRate);
                        f.wealth -= d; f.flash = 2;
                    }
                });
                // æ¨¡æ‹Ÿå°‘é‡çš„éšæœºæ”¶ç›Šç‚¹
                if (Math.random() < 0.005) f.wealth += 10;
                
                f.draw();

                if (f.hasIns) { insWealth += f.wealth; insCount++; }
                else { uniWealth += f.wealth; uniCount++; }
            });

            // æ›´æ–°çŠ¶æ€
            document.getElementById('ins-alive').innerText = insCount;
            document.getElementById('uni-alive').innerText = uniCount;
            let ratio = (insCount > 0 && uniCount > 0) ? 
                ((insWealth/insCount) / (uniWealth/uniCount)).toFixed(2) : "N/A";
            document.getElementById('wealth-ratio').innerText = ratio;
        }
        requestAnimationFrame(loop);
    }

    // æ§åˆ¶é€»è¾‘
    document.getElementById('p-risks').addEventListener('input', (e) => {
        conf.riskCount = parseInt(e.target.value);
        document.getElementById('v-risks').innerText = conf.riskCount;
        updateRisks();
    });
    document.getElementById('p-rate').addEventListener('input', (e) => {
        conf.insRate = parseInt(e.target.value) / 100;
        document.getElementById('v-rate').innerText = e.target.value;
    });

    function togglePause() {
        isPaused = !isPaused;
        document.getElementById('pauseBtn').innerText = isPaused ? "â–¶ ç»§ç»­" : "â¸ æš‚åœ";
    }

    window.onload = () => { init(); loop(); };
</script>
</body>
</html>