<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è¿­ä»£1ï¼šä¿é™©ç­–ç•¥äºŒå…ƒåšå¼ˆ</title>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 300px; background: #1e1e1e; padding: 20px; border-right: 1px solid #333; overflow-y: auto; }
        h2 { color: #00bcd4; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .param-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85em; color: #bbb; margin-bottom: 5px; }
        input[type="range"] { width: 100%; cursor: pointer; }
        .val-disp { float: right; color: #00bcd4; font-weight: bold; }
        button { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-init { background: #00bcd4; color: white; }
        .btn-init:hover { background: #00acc1; }
        .btn-pause { background: #ff9800; color: white; }
        #main { flex: 1; display: flex; padding: 20px; gap: 20px; }
        .canvas-box { background: #000; border: 1px solid #444; border-radius: 8px; position: relative; flex: 1; }
        canvas { display: block; width: 100%; height: 100%; }
        .label-tag { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 4px 10px; font-size: 12px; color: #ccc; border-radius: 4px; pointer-events: none; }
        #charts-col { width: 450px; display: flex; flex-direction: column; gap: 20px; }
        .chart-container { flex: 1; background: #1e1e1e; border-radius: 8px; padding: 10px; position: relative;}
        .legend-box { font-size: 12px; margin-bottom: 10px; display: flex; gap: 15px;}
        .leg-item { display: flex; align-items: center; }
        .leg-color { width: 10px; height: 10px; margin-right: 5px; border-radius: 50%; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>è¿­ä»£1ï¼šå‚æ•°æ§åˆ¶</h2>
    <div class="param-group">
        <label>æ€»äººå£ (å¼ºåˆ¶50/50åˆ†ç»„): <span class="val-disp" id="v-pop">400</span></label>
        <input type="range" id="p-pop" min="100" max="800" step="10" value="400">
    </div>
    <div class="param-group">
        <label>é£é™©äº‹ä»¶å¯†åº¦: <span class="val-disp" id="v-risks">40</span></label>
        <input type="range" id="p-risks" min="0" max="150" value="40">
    </div>
    <div class="param-group">
        <label>å¥½äº‹å‘ç”Ÿå¯†åº¦: <span class="val-disp" id="v-goods">40</span></label>
        <input type="range" id="p-goods" min="0" max="150" value="40">
    </div>
    <hr style="border-color:#333">
    <div class="param-group">
        <label>å•æ¬¡é£é™©æœ€å¤§ä¼¤å®³: <span class="val-disp" id="v-damage">50</span></label>
        <input type="range" id="p-damage" min="10" max="100" value="50">
    </div>
    <div class="param-group">
        <label>ä¿é™©ç†èµ”ç‡ (å‡ä¼¤%): <span class="val-disp" id="v-ins-rate">90</span></label>
        <input type="range" id="p-ins-rate" min="50" max="100" value="90">
    </div>
    <div class="param-group">
        <label>æ¯å¸§ä¿è´¹æˆæœ¬: <span class="val-disp" id="v-ins-cost">0.05</span></label>
        <input type="range" id="p-ins-cost" min="0.01" max="0.2" step="0.01" value="0.05">
    </div>

    <button class="btn-init" onclick="resetSim()">ğŸ”„ é‡ç½®å®éªŒ</button>
    <button class="btn-pause" onclick="togglePause()" id="pauseBtn">â¯ æš‚åœ/ç»§ç»­</button>
</div>

<div id="main">
    <div class="canvas-box">
        <div class="label-tag">ç‰©ç†ç¢°æ’åœº (é’åœˆ=å‚ä¿ç»„, æ— åœˆ=è£¸å¥”ç»„)</div>
        <canvas id="simCanvas"></canvas>
    </div>

    <div id="charts-col">
        <div class="chart-container">
            <div class="legend-box">
                 <span style="font-weight:bold; color:#ccc">åŒè½¨è´¢å¯Œæ›²çº¿ (æ’åºå):</span>
                 <div class="leg-item"><div class="leg-color" style="background:cyan"></div>å‚ä¿ç»„</div>
                 <div class="leg-item"><div class="leg-color" style="background:#ff5555"></div>è£¸å¥”ç»„</div>
            </div>
            <canvas id="curveCanvas"></canvas>
        </div>
        <div class="chart-container">
            <div class="legend-box">
                 <span style="font-weight:bold; color:#ccc">æ ¸å¿ƒæŒ‡æ ‡å¯¹æ¯”:</span>
            </div>
            <canvas id="barCanvas"></canvas>
        </div>
    </div>
</div>

<script>
// --- é…ç½®ä¸å…¨å±€å˜é‡ ---
const canvasIds = ['simCanvas', 'curveCanvas', 'barCanvas'];
const ctxs = {};
let families = [], risks = [], goods = [];
let isPaused = false, animationId;

// --- å·¥å…·å‡½æ•° ---
function getConf() {
    return {
        pop: parseInt(document.getElementById('p-pop').value),
        risks: parseInt(document.getElementById('p-risks').value),
        goods: parseInt(document.getElementById('p-goods').value),
        damage: parseInt(document.getElementById('p-damage').value),
        insRate: parseInt(document.getElementById('p-ins-rate').value) / 100,
        insCost: parseFloat(document.getElementById('p-ins-cost').value),
        gain: 30 // å›ºå®šå¥½äº‹æ”¶ç›Šï¼Œå‡å°‘å˜é‡
    };
}
document.querySelectorAll('input[type="range"]').forEach(input => {
    input.addEventListener('input', (e) => document.getElementById('v-' + e.target.id.split('-').slice(1).join('-')).innerText = e.target.value);
});

// --- ç±»å®šä¹‰ ---
class Family {
    constructor(isInsured) {
        this.x = Math.random() * ctxs.simCanvas.canvas.width;
        this.y = Math.random() * ctxs.simCanvas.canvas.height;
        this.vx = (Math.random() - 0.5) * 1.5;
        this.vy = (Math.random() - 0.5) * 1.5;
        this.wealth = 50 + Math.random() * 50; // åˆå§‹è´¢å¯Œ 50-100
        this.alive = true;
        this.hasIns = isInsured; // å¼ºåˆ¶è®¾å®šï¼Œç»ˆèº«ä¸å˜
        this.flash = 0;
    }
    update(conf) {
        if (!this.alive) return;
        this.x += this.vx; this.y += this.vy;
        if (this.x < 0 || this.x > ctxs.simCanvas.canvas.width) this.vx *= -1;
        if (this.y < 0 || this.y > ctxs.simCanvas.canvas.height) this.vy *= -1;

        // ä¿è´¹æ‰£é™¤é€»è¾‘
        if (this.hasIns) this.wealth -= conf.insCost;
        
        if (this.wealth <= 0) { this.wealth = 0; this.alive = false; }
        if (this.flash > 0) this.flash--;
    }
    draw() {
        if (!this.alive) return;
        const ctx = ctxs.simCanvas;
        ctx.beginPath();
        // å‚ä¿ç»„çš„é’è‰²å…‰ç¯
        if (this.hasIns) {
            ctx.strokeStyle = "rgba(0, 255, 255, 0.8)"; ctx.lineWidth = 2;
            ctx.arc(this.x, this.y, 7, 0, Math.PI*2); ctx.stroke();
        }
        // æœ¬ä½“é¢œè‰²æ ¹æ®è´¢å¯Œå˜åŒ–
        let r = this.wealth < 50 ? 255 : Math.max(0, 255 - (this.wealth-50)*2);
        let g = this.wealth > 50 ? 255 : Math.max(0, this.wealth*3);
        ctx.fillStyle = this.flash > 0 ? "white" : `rgb(${r},${g},50)`;
        ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI*2); ctx.fill();
    }
}

class Particle {
    constructor(type) {
        this.type = type;
        this.x = Math.random() * ctxs.simCanvas.canvas.width;
        this.y = Math.random() * ctxs.simCanvas.canvas.height;
        this.vx = (Math.random() - 0.5) * 5;
        this.vy = (Math.random() - 0.5) * 5;
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        if (this.x < 0 || this.x > ctxs.simCanvas.canvas.width) this.vx *= -1;
        if (this.y < 0 || this.y > ctxs.simCanvas.canvas.height) this.vy *= -1;
    }
    draw() {
        const ctx = ctxs.simCanvas;
        ctx.fillStyle = this.type === 'risk' ? "#ff3333" : "#ffd700";
        ctx.beginPath(); ctx.arc(this.x, this.y, this.type==='risk'?4:5, 0, Math.PI*2); ctx.fill();
        if(this.type==='risk'){ ctx.fillStyle='white'; ctx.font='10px sans-serif'; ctx.fillText('Ã—', this.x-3, this.y+3);}
    }
}

// --- ä¸»å¾ªç¯ä¸åˆå§‹åŒ– ---
function resetSim() {
    const conf = getConf();
    canvasIds.forEach(id => {
        const cvs = document.getElementById(id);
        cvs.width = cvs.clientWidth; cvs.height = cvs.clientHeight;
        ctxs[id] = cvs.getContext('2d');
    });
    
    families = [];
    // å¼ºåˆ¶50/50è®¾å®š
    for (let i = 0; i < conf.pop; i++) {
        families.push(new Family(i % 2 === 0)); // å¶æ•°å‚ä¿ï¼Œå¥‡æ•°ä¸å‚ä¿
    }
    risks = Array.from({length: conf.risks}, () => new Particle('risk'));
    goods = Array.from({length: conf.goods}, () => new Particle('good'));
    isPaused = false;
    if (animationId) cancelAnimationFrame(animationId);
    loop();
}

function loop() {
    if (!isPaused) {
        const conf = getConf();
        ctxs.simCanvas.fillStyle = "rgba(0,0,0,0.2)";
        ctxs.simCanvas.fillRect(0, 0, ctxs.simCanvas.canvas.width, ctxs.simCanvas.canvas.height);
        
        [...risks, ...goods].forEach(p => { p.update(); p.draw(); });
        
        families.forEach(f => {
            if (!f.alive) return;
            f.update(conf);
            // ç¢°æ’æ£€æµ‹
            risks.forEach(r => {
                if (Math.hypot(f.x-r.x, f.y-r.y) < 10) {
                    let dmg = Math.random() * conf.damage;
                    if (f.hasIns) dmg *= (1 - conf.insRate); // å‚ä¿å‡ä¼¤
                    f.wealth -= dmg; f.flash = 2;
                }
            });
            goods.forEach(g => {
                if (Math.hypot(f.x-g.x, f.y-g.y) < 10) {
                    f.wealth += Math.random() * conf.gain; f.flash = 2;
                }
            });
            f.draw();
        });
        drawCharts();
    }
    animationId = requestAnimationFrame(loop);
}

// --- å›¾è¡¨ç»˜åˆ¶ (æ ¸å¿ƒä¿®æ”¹) ---
function drawCharts() {
    const insuredAlive = families.filter(f => f.alive && f.hasIns);
    const uninsuredAlive = families.filter(f => f.alive && !f.hasIns);

    // 1. ç»˜åˆ¶åŒè½¨è´¢å¯Œæ›²çº¿
    const cCtx = ctxs.curveCanvas;
    const cW = cCtx.canvas.width, cH = cCtx.canvas.height;
    cCtx.clearRect(0,0,cW,cH);

    const drawCurve = (group, color) => {
        if(group.length === 0) return;
        const wealths = group.map(f => f.wealth).sort((a,b) => a-b);
        const maxW = Math.max(200, ...wealths); // å›ºå®šä¸€ä¸ªYè½´åŸºå‡†ä»¥ä¾¿æ¯”è¾ƒ
        cCtx.beginPath(); cCtx.strokeStyle = color; cCtx.lineWidth = 2;
        wealths.forEach((w, i) => {
            const x = (i / (wealths.length-1 || 1)) * cW;
            const y = cH - (w / maxW) * (cH - 20) - 10;
            i===0 ? cCtx.moveTo(x,y) : cCtx.lineTo(x,y);
        });
        cCtx.stroke();
    }
    drawCurve(uninsuredAlive, '#ff5555'); // å…ˆç”»çº¢çº¿
    drawCurve(insuredAlive, 'cyan');    // åç”»é’çº¿å åŠ 

    // 2. ç»˜åˆ¶å¯¹æ¯”æŸ±çŠ¶å›¾
    const bCtx = ctxs.barCanvas;
    const bW = bCtx.canvas.width, bH = bCtx.canvas.height;
    bCtx.clearRect(0,0,bW,bH);
    
    // è®¡ç®—æ•°æ®
    const insPop = insuredAlive.length;
    const uninsPop = uninsuredAlive.length;
    const insAvg = insPop ? insuredAlive.reduce((a,b)=>a+b.wealth,0)/insPop : 0;
    const uninsAvg = uninsPop ? uninsuredAlive.reduce((a,b)=>a+b.wealth,0)/uninsPop : 0;
    
    const drawBarGroup = (xBase, title, val1, val2, maxVal, color1, color2) => {
        bCtx.fillStyle = '#ccc'; bCtx.font = "12px sans-serif"; bCtx.fillText(title, xBase+10, 20);
        const barW = 40; const maxBarH = bH - 60;
        const h1 = (val1/maxVal)*maxBarH; const h2 = (val2/maxVal)*maxBarH;
        // Bar 1
        bCtx.fillStyle = color1; bCtx.fillRect(xBase + 20, bH-h1-20, barW, h1);
        bCtx.fillText(Math.round(val1), xBase + 20, bH-h1-25);
        // Bar 2
        bCtx.fillStyle = color2; bCtx.fillRect(xBase + 80, bH-h2-20, barW, h2);
        bCtx.fillText(Math.round(val2), xBase + 80, bH-h2-25);
        // Labels
        bCtx.fillStyle = '#888'; bCtx.font = "10px sans-serif";
        bCtx.fillText("å‚ä¿", xBase+25, bH-5); bCtx.fillText("è£¸å¥”", xBase+85, bH-5);
    }

    drawBarGroup(0, "å­˜æ´»äººæ•°å¯¹æ¯”", insPop, uninsPop, getConf().pop/2, 'cyan', '#ff5555');
    drawBarGroup(bW/2, "å¹³å‡è´¢å¯Œå¯¹æ¯”", insAvg, uninsAvg, Math.max(insAvg, uninsAvg, 100), 'cyan', '#ff5555');
}

function togglePause() {
    isPaused = !isPaused; document.getElementById('pauseBtn').innerText = isPaused ? "â–¶ ç»§ç»­" : "â¸ æš‚åœ";
}
window.onload = resetSim;
</script>
</body>
</html>
